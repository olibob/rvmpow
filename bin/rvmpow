#!/usr/bin/env ruby
# encoding: utf-8

require 'thor'
require 'rvmpow'

class CLI < Thor

	def initialize(*args)
	  super
	  exitIfNotRakeAppOrNoRvm
	  @pow = RvmPow::Pow.new
	end

	desc "init", "enable pow"
	long_desc <<-LONGDESC
		`rvmpow init` will:

		- create a '.powenv' file in the current directory.
		\x5- add .powenv to the .gitignore file
		\x5- add the current app to pow
	LONGDESC
	option :show, type: :boolean, desc: "open in default browser"
	def init

		if @pow.init
			say_status "Done", "Initialization", :green
			if options[:show]
				say "Opening app in default browser"
				open
			else
				say "Open your app in the default with `rvmpow open`"
			end
		else
			say_status "Failed", "Initialization.", :red
		end

	end

	desc "open", "open the current rake app in the default browser"
	def open
		%x(open http://#{RvmPow::APP_NAME}.dev)
	end

	desc "clear", "disable pow"
	long_desc <<-LONGDESC
		`rvmpow clear` will remove only the files necessary for pow.
	LONGDESC
	def clear
		@pow.clear
	end

	private
		def rakeApp?
			File.exists?(RvmPow::CONFIG_RU)
		end

		def rvm?
			File.exists?(RvmPow::RVM_BINARY)
		end

		def exitIfNotRakeAppOrNoRvm
			if !(rakeApp? && rvm?)
			error "The current directory does not seem to be the root of a rake app or rvm is not installed. Nothing to do!"
			exit 0
		end

		end
end

CLI.start(ARGV)